<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SGCI Auth Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;500;700&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f2ec;
        --ink: #121212;
        --muted: #6b6b6b;
        --card: #ffffff;
        --accent: #0f8a86;
        --accent-2: #f29f50;
        --danger: #c9463d;
        --shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        background: radial-gradient(1200px 700px at 15% 10%, #fef7ea, transparent),
          radial-gradient(900px 600px at 85% 20%, #e2f3f2, transparent),
          linear-gradient(120deg, #f1eee9, #f4efe7 65%, #efe7dd);
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        min-height: 100vh;
      }

      .page {
        max-width: 1150px;
        margin: 0 auto;
        padding: 42px 28px 64px;
        display: grid;
        gap: 28px;
      }

      header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px 28px;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: grid;
        gap: 8px;
      }

      .brand h1 {
        font-family: "Fraunces", Georgia, serif;
        font-size: clamp(2.2rem, 4vw, 3.4rem);
        margin: 0;
        letter-spacing: -0.02em;
      }

      .brand p {
        margin: 0;
        color: var(--muted);
        max-width: 520px;
      }

      .status {
        background: #fff7e6;
        border: 1px solid #f0d9b8;
        color: #8a5a1f;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.92rem;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 22px;
      }

      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 20px 22px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        animation: rise 0.7s ease forwards;
        opacity: 0;
      }

      .card::after {
        content: "";
        position: absolute;
        inset: 0;
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 18px;
        pointer-events: none;
      }

      .card h2 {
        margin: 0 0 12px;
        font-size: 1.2rem;
      }

      .field {
        display: grid;
        gap: 6px;
        margin-bottom: 12px;
      }

      label {
        font-size: 0.86rem;
        color: var(--muted);
      }

      input,
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d4d4d4;
        font-size: 0.95rem;
        font-family: inherit;
      }

      input:focus,
      select:focus {
        outline: 2px solid rgba(15, 138, 134, 0.25);
        border-color: var(--accent);
      }

      button {
        width: 100%;
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        background: var(--accent);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(15, 138, 134, 0.25);
      }

      button.secondary {
        background: #111;
      }

      button.ghost {
        background: transparent;
        border: 1px solid #c9c9c9;
        color: #222;
      }

      .token-box {
        background: #f9f6f1;
        border-radius: 12px;
        padding: 10px 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.8rem;
        word-break: break-all;
        min-height: 88px;
      }

      .row {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(15, 138, 134, 0.1);
        color: var(--accent);
        font-size: 0.82rem;
        font-weight: 600;
      }

      .warn {
        color: var(--danger);
      }

      .muted {
        color: var(--muted);
        font-size: 0.88rem;
      }

      .footer {
        text-align: center;
        color: var(--muted);
        font-size: 0.85rem;
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card:nth-child(1) {
        animation-delay: 0.05s;
      }
      .card:nth-child(2) {
        animation-delay: 0.1s;
      }
      .card:nth-child(3) {
        animation-delay: 0.15s;
      }
      .card:nth-child(4) {
        animation-delay: 0.2s;
      }

      @media (max-width: 720px) {
        .page {
          padding: 32px 18px 48px;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div class="brand">
          <h1>SGCI Auth Lab</h1>
          <p>
            Tableau de test pour register, login, refresh et logout. Renseigne
            l'URL API, puis joue avec les jetons.
          </p>
        </div>
        <div class="status" id="status">API non verifiee</div>
      </header>

      <div class="card">
        <h2>Connexion API</h2>
        <div class="field">
          <label for="apiBase">Base URL</label>
          <input
            id="apiBase"
            type="text"
            value="http://127.0.0.1:8000"
          />
        </div>
        <div class="row">
          <button id="ping">Tester /health</button>
          <button id="clear" class="ghost">Vider les jetons</button>
        </div>
        <p class="muted">
          Si tu ouvres ce fichier en local, un CORS error peut arriver. Dans ce
          cas, lance un petit serveur statique.
        </p>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Register</h2>
          <div class="field">
            <label for="regEmail">Email</label>
            <input id="regEmail" type="email" placeholder="user@sgci.io" />
          </div>
          <div class="field">
            <label for="regPassword">Mot de passe</label>
            <input id="regPassword" type="password" placeholder="********" />
          </div>
          <div class="field">
            <label for="regRole">Role</label>
            <select id="regRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
              <option value="manager">manager</option>
            </select>
          </div>
          <button id="registerBtn">Creer un compte</button>
        </div>

        <div class="card">
          <h2>Login</h2>
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="user@sgci.io" />
          </div>
          <div class="field">
            <label for="loginPassword">Mot de passe</label>
            <input id="loginPassword" type="password" placeholder="********" />
          </div>
          <button id="loginBtn">Se connecter</button>
        </div>

        <div class="card">
          <h2>Jetons</h2>
          <div class="pill" id="tokenStatus">Aucun jeton</div>
          <div class="field">
            <label>Access token</label>
            <div class="token-box" id="accessBox"></div>
          </div>
          <div class="field">
            <label>Refresh token</label>
            <div class="token-box" id="refreshBox"></div>
          </div>
          <div class="row">
            <button id="refreshBtn" class="secondary">Refresh</button>
            <button id="logoutBtn" class="ghost">Logout</button>
          </div>
        </div>

        <div class="card">
          <h2>Profil protege</h2>
          <p class="muted">
            Appel du endpoint <code>/me</code> avec le bearer token.
          </p>
          <button id="meBtn">Charger /me</button>
          <pre class="token-box" id="meBox"></pre>
          <p class="muted warn" id="errorBox"></p>
        </div>
      </div>

      <div class="footer">SGCI Auth Lab - front de test</div>
    </div>

    <script>
      const els = {
        status: document.getElementById("status"),
        apiBase: document.getElementById("apiBase"),
        accessBox: document.getElementById("accessBox"),
        refreshBox: document.getElementById("refreshBox"),
        tokenStatus: document.getElementById("tokenStatus"),
        meBox: document.getElementById("meBox"),
        errorBox: document.getElementById("errorBox"),
      };

      const storageKey = "sgci_auth_tokens";

      function loadTokens() {
        try {
          const raw = localStorage.getItem(storageKey);
          return raw ? JSON.parse(raw) : { access: "", refresh: "" };
        } catch {
          return { access: "", refresh: "" };
        }
      }

      function saveTokens(access, refresh) {
        localStorage.setItem(storageKey, JSON.stringify({ access, refresh }));
        renderTokens();
      }

      function renderTokens() {
        const { access, refresh } = loadTokens();
        els.accessBox.textContent = access || "Aucun access token";
        els.refreshBox.textContent = refresh || "Aucun refresh token";
        els.tokenStatus.textContent = access
          ? "Jetons charges"
          : "Aucun jeton";
      }

      function apiBase() {
        return els.apiBase.value.replace(/\/$/, "");
      }

      function setStatus(text, tone = "info") {
        els.status.textContent = text;
        els.status.style.background =
          tone === "error" ? "#f7e3e2" : "#fff7e6";
        els.status.style.borderColor =
          tone === "error" ? "#e0b7b5" : "#f0d9b8";
        els.status.style.color = tone === "error" ? "#9b3d37" : "#8a5a1f";
      }

      async function request(path, options = {}) {
        const url = `${apiBase()}${path}`;
        const headers = options.headers || {};
        if (options.json) {
          headers["Content-Type"] = "application/json";
        }
        const res = await fetch(url, {
          method: options.method || "POST",
          headers,
          body: options.json ? JSON.stringify(options.json) : undefined,
        });
        const text = await res.text();
        let data = text;
        try {
          data = JSON.parse(text);
        } catch {}
        if (!res.ok) {
          const msg = typeof data === "string" ? data : JSON.stringify(data);
          throw new Error(msg || "Request failed");
        }
        return data;
      }

      document.getElementById("ping").addEventListener("click", async () => {
        try {
          const res = await request("/health", { method: "GET" });
          setStatus(`API OK: ${JSON.stringify(res)}`);
        } catch (err) {
          setStatus(`API KO: ${err.message}`, "error");
        }
      });

      document
        .getElementById("registerBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("regEmail").value.trim();
          const password = document.getElementById("regPassword").value;
          const role = document.getElementById("regRole").value;
          try {
            const res = await request("/auth/register", {
              json: { email, password, role },
            });
            setStatus(`Compte cree: ${res.email}`);
          } catch (err) {
            setStatus(`Register error: ${err.message}`, "error");
          }
        });

      document
        .getElementById("loginBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("loginEmail").value.trim();
          const password = document.getElementById("loginPassword").value;
          try {
            const res = await request("/auth/login", {
              json: { email, password },
            });
            saveTokens(res.access_token, res.refresh_token);
            setStatus("Login OK");
          } catch (err) {
            setStatus(`Login error: ${err.message}`, "error");
          }
        });

      document
        .getElementById("refreshBtn")
        .addEventListener("click", async () => {
          const { refresh } = loadTokens();
          if (!refresh) {
            setStatus("Pas de refresh token", "error");
            return;
          }
          try {
            const res = await request(
              `/auth/refresh?refresh_token=${encodeURIComponent(refresh)}`
            );
            saveTokens(res.access_token, res.refresh_token);
            setStatus("Refresh OK");
          } catch (err) {
            setStatus(`Refresh error: ${err.message}`, "error");
          }
        });

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        const { refresh } = loadTokens();
        if (!refresh) {
          setStatus("Pas de refresh token", "error");
          return;
        }
        try {
          await request(
            `/auth/logout?refresh_token=${encodeURIComponent(refresh)}`
          );
          saveTokens("", "");
          setStatus("Logout OK");
        } catch (err) {
          setStatus(`Logout error: ${err.message}`, "error");
        }
      });

      document.getElementById("meBtn").addEventListener("click", async () => {
        const { access } = loadTokens();
        if (!access) {
          els.errorBox.textContent = "Pas de access token";
          return;
        }
        els.errorBox.textContent = "";
        try {
          const res = await request("/me", {
            method: "GET",
            headers: { Authorization: `Bearer ${access}` },
          });
          els.meBox.textContent = JSON.stringify(res, null, 2);
        } catch (err) {
          els.errorBox.textContent = err.message;
        }
      });

      document.getElementById("clear").addEventListener("click", () => {
        saveTokens("", "");
        els.meBox.textContent = "";
        setStatus("Jetons effaces");
      });

      renderTokens();
    </script>
  </body>
</html>
